@model CondoManagementWebApp.Models.CreateOneTimePaymentViewModel

@{
    ViewData["Title"] = "Create One-Time Payment";
}

<div class="content-body">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-xl-8 col-xxl-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <h4 class="card-title welcome-text mb-0">Schedule Payment</h4>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="text-center mb-3">
                            <a href="@Url.Action("Index", "Home")"><img class="logo-auth" src="~/images/logo-full.png" alt="Logo"></a>
                        </div>
                        <form asp-action="RequestCreateOneTimePayment">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                            <!-- Due Date -->
                            <div class="form-group mb-3">
                                <label asp-for="DueDate" class="control-label"></label>
                                <input id="dueDateInput" asp-for="DueDate" class="form-control" />
                                <span asp-validation-for="DueDate" class="text-danger"></span>
                            </div>

                            <!-- Condominium Selector -->
                            <div class="form-group mb-3">
                                <label asp-for="CondominiumId" class="form-label">Condominium Payment Reference</label>
                                <select asp-for="CondominiumId" asp-items="Model.CondosToSelect" class="form-control" id="CondominiumId">
                                    <option value="">-- Select Condominium --</option>
                                </select>
                                <span asp-validation-for="CondominiumId" class="text-danger"></span>
                            </div>

                            <!-- Select Payer -->
                            <div class="form-group mb-3">
                                <label class="control-label">Select Payer</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="SelectedPayerType" value="Condominium" id="payerCondo" checked />
                                    <label class="form-check-label" for="payerCondo">Condominium</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="SelectedPayerType" value="Member" id="payerMember" disabled />
                                    <label class="form-check-label" for="payerMember">Member</label>
                                </div>
                            </div>

                            <!-- Beneficiary Type (só visível se payerCondo for escolhido) -->
                            <div class="form-group mb-3" id="beneficiaryTypeWrapper">
                                <label class="form-label font-weight-bold text-purple">Recipient Type</label><br />
                                @if (Model.BeneficiaryTypeList != null)
                                {
                                    @foreach (var beneficiary in Model.BeneficiaryTypeList)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input beneficiary-type-radio" type="radio"
                                                   asp-for="SelectedBeneficiaryId"
                                                   value="@beneficiary.Value"
                                                   id="ben-@beneficiary.Value" />
                                            <label class="form-check-label" for="ben-@beneficiary.Value">@beneficiary.Text</label>
                                        </div>
                                    }
                                }
                                <span asp-validation-for="SelectedBeneficiaryId" class="text-danger"></span>
                            </div>

                            <!-- Recipient Name (External only) -->
                            <div class="form-group mb-3" id="recipientWrapper" style="display:none;">
                                <label asp-for="Recipient" class="control-label"></label>
                                <input asp-for="Recipient" class="form-control" placeholder="Enter recipient name" />
                                <span asp-validation-for="Recipient" class="text-danger"></span>
                            </div>

                            <!-- External Recipient Bank Account (External only) -->
                            <div class="form-group mb-3" id="externalRecipientFields" style="display:none;">
                                <label asp-for="ExternalRecipientBankAccount" class="control-label"></label>
                                <input asp-for="ExternalRecipientBankAccount" class="form-control" />
                                <span asp-validation-for="ExternalRecipientBankAccount" class="text-danger"></span>
                            </div>

                            <!-- Hidden Beneficiary Account ID -->
                            <input asp-for="BeneficiaryAccountId" type="hidden" />
                            <span asp-validation-for="BeneficiaryAccountId" class="text-danger"></span>

                            <!-- Member Selector -->
                            <div id="memberSelectWrapper" style="display:none;" class="form-group mb-3">
                                <label asp-for="SelectedCondoMemberId" class="form-label">Member</label>
                                <select asp-for="SelectedCondoMemberId" class="form-control" id="SelectedCondoMemberId">
                                    <option value="">-- Select Member --</option>
                                </select>
                            </div>

                            <!-- Expense Amount -->
                            <div class="form-group mb-3">
                                <label asp-for="ExpenseAmount" class="control-label"></label>
                                <input asp-for="ExpenseAmount" class="form-control" placeholder="Enter an amount" />
                                <span asp-validation-for="ExpenseAmount" class="text-danger"></span>
                            </div>

                            <!-- Expense Detail -->
                            <div class="form-group mb-3">
                                <label asp-for="ExpenseDetail" class="control-label"></label>
                                <input asp-for="ExpenseDetail" class="form-control" />
                                <span asp-validation-for="ExpenseDetail" class="text-danger"></span>
                            </div>

                            <!-- Expense Type -->
                            <div class="form-group mb-3">
                                <label asp-for="ExpenseTypeValue" class="form-label font-weight-bold text-purple">Expense Type</label>
                                <select asp-for="ExpenseTypeValue" asp-items="Model.ExpenseTypesList" class="form-control">
                                    <option value="">-- Select Expense Type --</option>
                                </select>
                                <span asp-validation-for="ExpenseTypeValue" class="text-danger"></span>
                            </div>

                            <!-- Actions -->
                            <div class="d-flex justify-content-between mt-3">
                                <a asp-action="IndexCondominiumPayments" class="btn btn-secondary">Back to List</a>
                                <input type="submit" value="Create" class="btn btn-primary" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const payerCondo = document.getElementById("payerCondo");
            const payerMember = document.getElementById("payerMember");
            const memberSelectWrapper = document.getElementById("memberSelectWrapper");
            const memberSelect = document.getElementById("SelectedCondoMemberId");
            const condoSelect = document.getElementById("CondominiumId");
            const beneficiaryWrapper = document.getElementById("beneficiaryTypeWrapper");

            function toggleMemberSelect() {
                memberSelectWrapper.style.display = payerMember.checked ? "block" : "none";
            }

            function toggleBeneficiaryType() {
                beneficiaryWrapper.style.display = payerCondo.checked ? "block" : "none";
            }

            function loadCondoMembers() {
                const condoId = condoSelect.value;

                if (condoId) {
                    payerMember.disabled = false;

                    const url = '@Url.Action("GetMembersByCondo", "Payment")' + `?condoId=${condoId}`;
                    fetch(url)
                        .then(r => r.json())
                        .then(data => {
                            memberSelect.innerHTML = '<option value="">-- Select Member --</option>';
                            data.forEach(m => {
                                let opt = document.createElement("option");
                                opt.value = m.id;
                                opt.text = m.name;
                                memberSelect.appendChild(opt);
                            });
                        })
                        .catch(err => console.error("Erro:", err));
                } else {
                    payerMember.checked = false;
                    payerCondo.checked = true;
                    payerMember.disabled = true;
                    toggleMemberSelect();
                    toggleBeneficiaryType();
                    memberSelect.innerHTML = '<option value="">-- Select Member --</option>';
                }
            }

            function updateBeneficiaryFields(selectedValue) {
                const recipientWrapper = document.getElementById("recipientWrapper");
                const externalFields = document.getElementById("externalRecipientFields");

                recipientWrapper.style.display = 'none';
                externalFields.style.display = 'none';

                if (selectedValue === "3") {
                    recipientWrapper.style.display = 'block';
                    externalFields.style.display = 'block';
                }
            }

            // Attach listeners
            document.querySelectorAll('.beneficiary-type-radio').forEach(radio => {
                radio.addEventListener('change', function () {
                    updateBeneficiaryFields(this.value);
                });
            });

            payerCondo.addEventListener("change", () => {
                toggleMemberSelect();
                toggleBeneficiaryType();
            });
            payerMember.addEventListener("change", () => {
                toggleMemberSelect();
                toggleBeneficiaryType();
            });
            condoSelect.addEventListener("change", loadCondoMembers);

            // Initialize
            toggleMemberSelect();
            toggleBeneficiaryType();

            const selectedBeneficiary = document.querySelector('.beneficiary-type-radio:checked');
            if (selectedBeneficiary) {
                updateBeneficiaryFields(selectedBeneficiary.value);
            }

            payerMember.disabled = !condoSelect.value;
        });
    </script>

    <style>
        .text-purple {
            color: #8A2BE2 !important;
        }

        .form-control {
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
        }

        select.form-control option {
            color: black;
        }
    </style>
}
