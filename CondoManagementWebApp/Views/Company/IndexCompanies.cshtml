@model CondoManagementWebApp.Models.IndexCompaniesViewModel

@{
    ViewData["Title"] = "IndexCompanies";
}

<h1>Companies</h1>

@if (!Model.Companies.Any())
{
<p>No companies registerd in the app yet</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Tax Id</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Companies)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>@item.Email</td>
                    <td>@item.TaxIdDocument</td>
                    <td>
                        @Html.ActionLink("Edit", "Edit", new { id = item.Id }, new { @class = "btn btn-secondary" }) 

                        @Html.ActionLink("Details", "Details", new { id = item.Id }, new { @class = "btn btn-primary" }) 

                        <a href="#" class="btn btn-danger " data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#deleteDialog">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

}

<div id="deleteDialog" class="modal fade">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this company?</p>
                <div id="delete-error-message" class="text-danger"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnNoDelete">Cancel</button>
                <button type="button" class="btn btn-danger" id="btnYesDelete">Delete</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script type="text/javascript">
        $(document).ready(function () {
            var idToDelete = 0;

            // Use o seletor para o link que abre o modal de deleção
            $('a[data-bs-target="#deleteDialog"]').click(function () {
                idToDelete = $(this).data('id');
                // Limpe a mensagem de erro anterior quando o modal é reaberto
                $('#delete-error-message').text('').hide();
            });

            $("#btnYesDelete").click(function () {
                console.log('ID para deletar:', idToDelete);
                console.log('URL da requisição:', '/Company/RequestDelete/' + idToDelete);

                $.ajax({
                    url: '/Company/RequestDelete/' + idToDelete,
                    type: 'DELETE',
                    success: function (response) {
                        // Verifique se a operação foi um sucesso
                        if (response.success) {
                            $("#deleteDialog").modal('hide'); // Fecha a modal APENAS no sucesso
                            window.location.reload();
                        } else {
                            // Se for um erro, exibe a mensagem, mas NÃO fecha a modal
                            $('#delete-error-message').text(response.message).show();
                        }
                    },
                    error: function (xhr, status, error) {
                        // Tratar erros de servidor (por exemplo, 500 Internal Server Error)
                        $("#deleteDialog").modal('hide');
                        console.error('AJAX Error:', status, error, xhr.responseText);
                        alert('Unexpected error, try again later.');
                    }
                });
            });

            $("#btnNoDelete").click(function () {
                $("#deleteDialog").modal('hide');
            });
        });
    </script>
}
